"""
Vector Database Setup Automation
Automates Weaviate and Pinecone setup with API key extraction
"""

import asyncio
import json
import logging
import os
from playwright.async_api import async_playwright
from typing import Dict, Optional
from datetime import datetime

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class VectorDBSetup:
    """Automates Weaviate and Pinecone setup"""
    
    def __init__(self, headless: bool = False):
        self.headless = headless
        self.browser = None
        self.context = None
        self.playwright = None
        self.credentials = {}
    
    async def start(self):
        """Initialize browser"""
        self.playwright = await async_playwright().start()
        self.browser = await self.playwright.chromium.launch(headless=self.headless)
        self.context = await self.browser.new_context(
            viewport={'width': 1920, 'height': 1080}
        )
        logger.info("ğŸš€ Browser started")
    
    async def stop(self):
        """Cleanup"""
        if self.browser:
            await self.browser.close()
        if self.playwright:
            await self.playwright.stop()
    
    async def setup_weaviate(self):
        """Setup Weaviate Cloud with step-by-step guidance"""
        page = await self.context.new_page()
        
        try:
            logger.info("ğŸ”· Setting up Weaviate Cloud...")
            
            await page.goto("https://console.weaviate.cloud/")
            await asyncio.sleep(3)
            
            print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  WEAVIATE CLOUD SETUP                                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ STEP 1: Sign Up / Login
   - If new: Click "Sign Up" â†’ Use Google/GitHub or email
   - If existing: Click "Login"
   
   â¸ï¸  Complete this step, then press Enter...
""")
            input("Press Enter when logged in...")
            
            await asyncio.sleep(3)
            
            print("""
ğŸ“‹ STEP 2: Create Sandbox Cluster (FREE)
   - Click "Create cluster" or "New cluster"
   - Select "Sandbox" (14-day free trial)
   - Choose a name (e.g., "clarity-pearl-db")
   - Select region closest to you
   - Click "Create"
   
   â³ Cluster creation takes 1-3 minutes...
   â¸ï¸  Wait for green checkmark âœ”ï¸, then press Enter...
""")
            input("Press Enter when cluster is ready...")
            
            await asyncio.sleep(2)
            
            print("""
ğŸ“‹ STEP 3: Get Connection Details
   - Click on your cluster name
   - You'll see "Cluster details" page
   - Find "REST Endpoint URL" â†’ Copy it
   - Find "gRPC Endpoint URL" (optional)
""")
            
            # Try to extract REST endpoint
            try:
                endpoint = await page.locator('input[value*="weaviate.cloud"]').first.input_value()
                if endpoint:
                    self.credentials['weaviate_endpoint'] = endpoint
                    logger.info(f"âœ… Endpoint: {endpoint}")
            except:
                pass
            
            if not self.credentials.get('weaviate_endpoint'):
                endpoint = input("ğŸ“ Paste REST Endpoint URL here: ").strip()
                if endpoint:
                    self.credentials['weaviate_endpoint'] = endpoint
            
            print("""
ğŸ“‹ STEP 4: Create API Key (For new clusters with RBAC)
   - Scroll down to "API Keys" section
   - Click "New key" button
   - Name: "clarity-pearl-api-key"
   - Role: Select "admin" (read-write access)
   - Click "Create key"
   
   âš ï¸  IMPORTANT: Copy the API key NOW! 
   You won't see it again!
""")
            
            # Try to extract API key
            try:
                api_key_elem = await page.locator('input[type="text"]').all()
                for elem in api_key_elem:
                    value = await elem.input_value()
                    if len(value) > 30 and '-' not in value[:10]:
                        self.credentials['weaviate_api_key'] = value
                        logger.info("âœ… API key extracted automatically!")
                        break
            except:
                pass
            
            if not self.credentials.get('weaviate_api_key'):
                api_key = input("ğŸ“ Paste API Key here: ").strip()
                if api_key:
                    self.credentials['weaviate_api_key'] = api_key
            
            logger.info("âœ… Weaviate setup complete!")
            logger.info(f"   Endpoint: {self.credentials.get('weaviate_endpoint', 'N/A')[:50]}...")
            logger.info(f"   API Key: {self.credentials.get('weaviate_api_key', 'N/A')[:20]}...")
            
        except Exception as e:
            logger.error(f"âŒ Error: {e}")
        finally:
            await page.close()
    
    async def setup_pinecone(self):
        """Setup Pinecone with step-by-step guidance"""
        page = await self.context.new_page()
        
        try:
            logger.info("ğŸ“Œ Setting up Pinecone...")
            
            await page.goto("https://app.pinecone.io/")
            await asyncio.sleep(3)
            
            print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  PINECONE SETUP                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ STEP 1: Sign Up / Login
   - If new: Click "Sign up free" â†’ Use Google/GitHub or email
   - If existing: Click "Log in"
   
   ğŸ’° FREE TIER: Starter plan with generous limits
      - 1 index
      - 100K vectors
      - Pod-based (free forever)
   
   â¸ï¸  Complete this step, then press Enter...
""")
            input("Press Enter when logged in...")
            
            await asyncio.sleep(3)
            
            print("""
ğŸ“‹ STEP 2: Get Your API Key
   - You should see the Dashboard
   - Look for "API Keys" in the left sidebar
   - Or go to: https://app.pinecone.io/organizations/-/projects/-/keys
   - Click "Create API Key" (if needed)
   - Name it: "clarity-pearl-key"
   - Copy the API key
   
   âš ï¸  IMPORTANT: Save the API key immediately!
""")
            
            # Navigate to API keys page
            try:
                await page.goto("https://app.pinecone.io/organizations/-/projects/-/keys")
                await asyncio.sleep(3)
            except:
                pass
            
            # Try to extract API key
            try:
                key_elements = await page.locator('code, pre, input[type="text"]').all()
                for elem in key_elements:
                    value = await elem.text_content() if hasattr(elem, 'text_content') else await elem.input_value()
                    if value and len(value) > 30 and value.startswith(('pc-', 'pcsk-')):
                        self.credentials['pinecone_api_key'] = value
                        logger.info("âœ… API key extracted automatically!")
                        break
            except:
                pass
            
            if not self.credentials.get('pinecone_api_key'):
                api_key = input("ğŸ“ Paste Pinecone API Key here: ").strip()
                if api_key:
                    self.credentials['pinecone_api_key'] = api_key
            
            print("""
ğŸ“‹ STEP 3: Note Your Environment
   - In the API Keys page, you'll see "Environment"
   - Common environments: 
     * us-east-1-aws (most common)
     * us-west1-gcp
     * eu-west1-gcp
   - This is auto-detected by the SDK usually
""")
            
            environment = input("ğŸ“ Pinecone Environment (or press Enter for default): ").strip()
            if environment:
                self.credentials['pinecone_environment'] = environment
            
            logger.info("âœ… Pinecone setup complete!")
            logger.info(f"   API Key: {self.credentials.get('pinecone_api_key', 'N/A')[:20]}...")
            
        except Exception as e:
            logger.error(f"âŒ Error: {e}")
        finally:
            await page.close()
    
    def save_credentials(self, filename: str = ".env"):
        """Save credentials to .env file"""
        try:
            # Read existing .env if it exists
            existing_vars = {}
            if os.path.exists(filename):
                with open(filename, 'r') as f:
                    for line in f:
                        line = line.strip()
                        if line and not line.startswith('#') and '=' in line:
                            key, value = line.split('=', 1)
                            existing_vars[key] = value
            
            # Add new credentials
            if self.credentials.get('weaviate_endpoint'):
                existing_vars['WEAVIATE_ENDPOINT'] = self.credentials['weaviate_endpoint']
            if self.credentials.get('weaviate_api_key'):
                existing_vars['WEAVIATE_API_KEY'] = self.credentials['weaviate_api_key']
            if self.credentials.get('pinecone_api_key'):
                existing_vars['PINECONE_API_KEY'] = self.credentials['pinecone_api_key']
            if self.credentials.get('pinecone_environment'):
                existing_vars['PINECONE_ENVIRONMENT'] = self.credentials['pinecone_environment']
            
            # Write back to .env
            with open(filename, 'w') as f:
                f.write("# Environment Variables\n")
                f.write(f"# Updated: {datetime.now().isoformat()}\n\n")
                
                for key, value in sorted(existing_vars.items()):
                    f.write(f"{key}={value}\n")
            
            logger.info(f"âœ… Credentials saved to {filename}")
            
        except Exception as e:
            logger.error(f"âŒ Error saving credentials: {e}")
    
    def generate_test_script(self):
        """Generate test script for vector databases"""
        test_code = '''"""
Test Vector Database Connections
"""

import os
from dotenv import load_dotenv

load_dotenv()

def test_weaviate():
    """Test Weaviate connection"""
    print("ğŸ”· Testing Weaviate...")
    
    try:
        import weaviate
        from weaviate.classes.init import Auth
        
        client = weaviate.connect_to_weaviate_cloud(
            cluster_url=os.getenv("WEAVIATE_ENDPOINT"),
            auth_credentials=Auth.api_key(os.getenv("WEAVIATE_API_KEY"))
        )
        
        if client.is_ready():
            print("âœ… Weaviate: Connected successfully!")
            print(f"   Cluster: {os.getenv('WEAVIATE_ENDPOINT')}")
        else:
            print("âŒ Weaviate: Connection failed")
        
        client.close()
        
    except Exception as e:
        print(f"âŒ Weaviate error: {e}")

def test_pinecone():
    """Test Pinecone connection"""
    print("\\nğŸ“Œ Testing Pinecone...")
    
    try:
        from pinecone import Pinecone
        
        pc = Pinecone(api_key=os.getenv("PINECONE_API_KEY"))
        
        # List indexes
        indexes = pc.list_indexes()
        print(f"âœ… Pinecone: Connected successfully!")
        print(f"   Indexes: {len(indexes)}")
        
        for index in indexes:
            print(f"   - {index['name']}")
        
    except Exception as e:
        print(f"âŒ Pinecone error: {e}")

if __name__ == "__main__":
    print("\\nğŸ§ª Testing Vector Database Connections...\\n")
    test_weaviate()
    test_pinecone()
    print("\\nâœ… Testing complete!")
'''
        
        with open("test_vector_dbs.py", "w") as f:
            f.write(test_code)
        
        logger.info("âœ… Generated test_vector_dbs.py")

# Main execution
async def main():
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Vector Database Setup Automation                             â•‘
â•‘  Weaviate + Pinecone                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

This script will help you:
1. âœ… Set up Weaviate Cloud (FREE Sandbox)
2. âœ… Set up Pinecone (FREE Starter tier)
3. âœ… Extract and save API keys
4. âœ… Generate test script

ğŸ’° COSTS: $0 - Both have generous free tiers!

Ready to start? (y/n): """)
    
    if input().lower() != 'y':
        return
    
    setup = VectorDBSetup(headless=False)
    
    try:
        await setup.start()
        
        print("\nğŸ”· Starting Weaviate setup...")
        await setup.setup_weaviate()
        
        print("\n" + "="*70)
        input("\nPress Enter to continue to Pinecone setup...")
        
        print("\nğŸ“Œ Starting Pinecone setup...")
        await setup.setup_pinecone()
        
        print("\n" + "="*70)
        print("\nğŸ’¾ Saving credentials...")
        setup.save_credentials()
        
        print("\nğŸ“ Generating test script...")
        setup.generate_test_script()
        
        print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âœ… SETUP COMPLETE!                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“„ Credentials saved to: .env

ğŸ§ª Test your connections:
   pip install weaviate-client pinecone-client
   python test_vector_dbs.py

ğŸ“‹ Next steps:
   1. Install required packages:
      pip install weaviate-client pinecone-client
   
   2. Test connections:
      python test_vector_dbs.py
   
   3. Update your clarity-pearl project to use these credentials

ğŸ’¡ Tips:
   - Weaviate Sandbox expires after 14 days (upgrade to Serverless for production)
   - Pinecone Starter is free forever with 1 index and 100K vectors
   - Keep your API keys secure and never commit them to Git!
""")
        
    except Exception as e:
        logger.error(f"âŒ Error: {e}")
    finally:
        await setup.stop()

if __name__ == "__main__":
    asyncio.run(main())